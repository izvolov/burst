#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from subprocess import Popen, PIPE
import argparse
import numpy as np
import matplotlib.pyplot as plt
import sys

def measure (algorithms, lengths, max_attempts, integer_type, prepare):
    measurements = {}

    command_template =\
        ("@CMAKE_BINARY_DIR@/benchmark/tools/rangegen "
            "--count=1 "
            "--length={} | "
        "@CMAKE_BINARY_DIR@/benchmark/burst/algorithm/radix "
            "--algo={} "
            "--attempts={} "
            "--integer={} "
            "--prepare={}")

    for length, attempts in [(l, int(max_attempts / l)) for l in lengths]:
        command = command_template.format(length, algorithms, attempts, integer_type, prepare)
        sys.stderr.write(command + '\n');
        results = Popen(command, shell=True, stdin=PIPE, stdout=PIPE).stdout.read().splitlines()

        for algorithm, time in [(a.decode('utf8'), float(t)) for a, t in [item.split() for item in results]]:
            times = measurements.setdefault(algorithm, [])
            times += [time]

    return measurements

def plot (lengths, measurements, integer_type, file_name):
    plt.rc('font',**{'family':'verdana'})
    plt.figure(num=1)
    plt.title(u'Сортировка целых чисел (' + integer_type + ')', size=14)
    plt.xlabel(u'Количество элементов в массиве, шт', size=10)
    plt.ylabel(u'Среднее время сортировки, с', size=10)
    plt.grid(True)

    x = np.array(lengths)

    for algorithm, times in measurements.items():
        y = np.array(times)
        plt.plot(x, y, label=algorithm)

    plt.xlim(left=0)
    plt.ylim(bottom=0)
    plt.legend(loc='upper left')
    plt.tight_layout()
    plt.savefig(file_name, format='png')

def table (lengths, measurements, integer_type, file_name):
    f = open(file_name, 'w')

    header_template = u''.join(['| {:<20} '] * (1 + len(measurements.items()))) + u'|\n'
    row_template = u'| {:<20} ' + u''.join(['| {:<20.2e} '] * (len(measurements.items()))) + u'|\n'

    table_string = header_template.format(u'Размер массива', *[a for a, _ in measurements.items()])
    table_string += u''.join(['| ' + '-' * 20 + ' '] * (1 + len(measurements.items()))) + u'|\n'
    for i in range(0, len(lengths)):
        table_string += row_template.format(lengths[i], *[times[i] for _, times in measurements.items()])

    f.write(table_string)

presets = {
    'all': ['radix', 'std', 'stable', 'boost'],
    'integral': ['radix', 'boost'],
}

def parse_command_line (options):
    parser = argparse.ArgumentParser(options[0])
    parser.add_argument('--begin', type=int, default=10,
        help='Минимальный размер массива')
    parser.add_argument('--end', type=int, default=100,
        help='Максимальный размер массива')
    parser.add_argument('--step', type=int, default=10,
        help='Шаг размера массива')
    parser.add_argument('--prefix', type=str, default='intsort',
        help='Префикс выходного файла')
    parser.add_argument('--integer', type=str, default='uint32',
        help='Тип сортируемых чисел',
        choices=['int8', 'int16', 'int32', 'int64', 'uint8', 'uint16', 'uint32', 'uint64'])
    parser.add_argument('--prepare', type=str, default='shuffle',
        help='Предобработка массива перед каждой сортировкой',
        choices=['shuffle', 'ascending', 'descending', 'outlier', 'pipe-organ', 'single'])
    parser.add_argument('--attempts', type=int, default=10000000,
        help='Максимальное количество итераций')
    parser.add_argument('--preset', type=str, default='all',
        help='Набор алгоритмов, которые нужно замерить', choices=presets.keys())
    args = parser.parse_args(options[1:])
    return args.begin, args.end, args.step, args.prefix, args.integer, args.prepare, args.attempts, args.preset

begin, end, step, prefix, integer_type, prepare, attempts, preset = parse_command_line(sys.argv)
lengths = range(begin, end, step)
algorithms = ' '.join(presets[preset])

measurements = measure(algorithms, lengths, attempts, integer_type, prepare)

file_name = '_'.join((prefix, str(begin), str(end), str(step), integer_type, prepare, preset, str(attempts)))
plot(lengths, measurements, integer_type, file_name + '.png')
table(lengths, measurements, integer_type, file_name + '.txt')
